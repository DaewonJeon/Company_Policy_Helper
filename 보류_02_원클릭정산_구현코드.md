# [í”„ë¡œì íŠ¸ 1] ì›í´ë¦­ ì •ì‚° ë° ë¦¬í¬íŠ¸ ìë™í™”: êµ¬í˜„ ì½”ë“œ

> **ëª©ì **: ì´ ë¬¸ì„œëŠ” ê°œë°œì(ë‚˜)ê°€ ì¦‰ì‹œ í”„ë¡œì íŠ¸ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ **ëª¨ë“  ì†ŒìŠ¤ ì½”ë“œ**ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
> **êµ¬ì¡°**: UI(`app.py`) + ë¡œì§(`src/`) + ì„¤ì •(`requirements.txt`)

---

## 1. í”„ë¡œì íŠ¸ í´ë” êµ¬ì¡° (Directory Structure)

ë¨¼ì € ì‘ì—… í´ë”ë¥¼ ì•„ë˜ì™€ ê°™ì´ êµ¬ì„±í•˜ì„¸ìš”.

```text
one_click_report/
â”œâ”€â”€ app.py                # ë©”ì¸ ì‹¤í–‰ íŒŒì¼ (Streamlit UI)
â”œâ”€â”€ requirements.txt      # ì˜ì¡´ì„± ë¼ì´ë¸ŒëŸ¬ë¦¬ ëª©ë¡
â”œâ”€â”€ .env                  # (ì„ íƒ) ì•± ë¹„ë°€ë²ˆí˜¸ ë“± í™˜ê²½ë³€ìˆ˜
â””â”€â”€ src/
    â”œâ”€â”€ __init__.py       
    â”œâ”€â”€ processor.py      # ì—‘ì…€ ë°ì´í„° ì²˜ë¦¬ ë° ê²€ì¦ ë¡œì§
    â””â”€â”€ mailer.py         # ì´ë©”ì¼ ë°œì†¡ ëª¨ë“ˆ
```

---

## 2. í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ (requirements.txt)

```text
streamlit       # ì›¹ UI í”„ë ˆì„ì›Œí¬
pandas          # ë°ì´í„° ê°€ê³µ ì—”ì§„
openpyxl        # ì—‘ì…€ íŒŒì¼ ì½ê¸°/ì“°ê¸° ë° ì„œì‹ ì§€ì •
python-dotenv   # í™˜ê²½ë³€ìˆ˜ ê´€ë¦¬ (.env)
```

---

## 3. í•µì‹¬ ë¡œì§ êµ¬í˜„ (src/processor.py)

ê°€ì¥ ì¤‘ìš”í•œ ë°ì´í„° ì²˜ë¦¬ ì—”ì§„ì…ë‹ˆë‹¤.
*   **ê¸°ëŠ¥**: ì—…ë¡œë“œëœ íŒŒì¼ë“¤ì„ ì½ì–´ í•©ì¹˜ê³ , í”¼ë²— í…Œì´ë¸”(ì§€ì ë³„ ë§¤ì¶œ í•©ê³„)ì„ ë§Œë“­ë‹ˆë‹¤.
*   **íŠ¹ì§•**: íŒŒì¼ëª…ì—ì„œ 'ì§€ì ëª…'ì„ ì¶”ì¶œí•´ë‚´ëŠ” ë¡œì§ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

```python
import pandas as pd
import os
import re
from io import BytesIO

class ExcelProcessor:
    def __init__(self):
        # ê²€ì¦í•˜ê³  ì‹¶ì€ í•„ìˆ˜ ì»¬ëŸ¼ë“¤
        self.REQUIRED_COLUMNS = ['ë‚ ì§œ', 'ìƒí’ˆëª…', 'ìˆ˜ëŸ‰', 'ë§¤ì¶œì•¡']

    def validate_and_merge(self, uploaded_files):
        """
        Streamlitì—ì„œ ì—…ë¡œë“œëœ íŒŒì¼ ë¦¬ìŠ¤íŠ¸ë¥¼ ë°›ì•„ ë³‘í•©í•©ë‹ˆë‹¤.
        
        Returns:
            merged_df: ë³‘í•©ëœ DataFrame
            error_log: ì˜¤ë¥˜ ë°œìƒ íŒŒì¼ ëª©ë¡ (íŒŒì¼ëª…, ì‚¬ìœ )
        """
        merged_list = []
        error_log = []

        for file in uploaded_files:
            try:
                # 1. íŒŒì¼ ì½ê¸° (ì—‘ì…€)
                df = pd.read_excel(file)

                # 2. ìœ íš¨ì„± ê²€ì‚¬ (í•„ìˆ˜ ì»¬ëŸ¼ ì¡´ì¬ ì—¬ë¶€)
                missing_cols = [col for col in self.REQUIRED_COLUMNS if col not in df.columns]
                if missing_cols:
                    error_log.append({
                        'file': file.name, 
                        'error': f"í•„ìˆ˜ ì»¬ëŸ¼ ëˆ„ë½: {', '.join(missing_cols)}"
                    })
                    continue

                # 3. ë°ì´í„° ì „ì²˜ë¦¬ (ì§€ì ëª… ì¶”ì¶œ)
                # íŒŒì¼ëª… ì˜ˆì‹œ: "2401_[ê°•ë‚¨ì ]_ì‹¤ì .xlsx" -> "ê°•ë‚¨ì " ì¶”ì¶œ
                branch_name = "Unknown"
                match = re.search(r'\[(.*?)\]', file.name)
                if match:
                    branch_name = match.group(1)
                
                df['ì§€ì ëª…'] = branch_name # ì§€ì ëª… ì»¬ëŸ¼ ì¶”ê°€
                
                # 4. ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
                merged_list.append(df)

            except Exception as e:
                error_log.append({'file': file.name, 'error': str(e)})

        if not merged_list:
            return None, error_log

        # 5. ì „ì²´ ë³‘í•©
        merged_df = pd.concat(merged_list, ignore_index=True)
        return merged_df, error_log

    def create_report(self, merged_df):
        """
        ë³‘í•©ëœ ë°ì´í„°ë¡œ ìµœì¢… ë³´ê³ ì„œ(Pivot Table)ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
        """
        # ì§€ì ë³„, ìƒí’ˆë³„ ë§¤ì¶œì•¡ í•©ê³„
        pivot_df = merged_df.pivot_table(
            index='ì§€ì ëª…', 
            columns='ìƒí’ˆëª…', 
            values='ë§¤ì¶œì•¡', 
            aggfunc='sum', 
            fill_value=0
        )
        
        # ì´í•© ì»¬ëŸ¼ ì¶”ê°€
        pivot_df['Total'] = pivot_df.sum(axis=1)
        
        return pivot_df
    
    def save_to_excel(self, df):
        """DataFrameì„ ì—‘ì…€ ë°”ì´ë„ˆë¦¬ë¡œ ë³€í™˜ (ë‹¤ìš´ë¡œë“œìš©)"""
        output = BytesIO()
        with pd.ExcelWriter(output, engine='openpyxl') as writer:
            df.to_excel(writer, sheet_name='ì¢…í•©ë¦¬í¬íŠ¸')
        data = output.getvalue()
        return data
```

---

## 4. ì´ë©”ì¼ ë°œì†¡ ëª¨ë“ˆ (src/mailer.py)

*   **ê¸°ëŠ¥**: ì²˜ë¦¬ê°€ ì™„ë£Œëœ ë¦¬í¬íŠ¸ë¥¼ íŒ€ì¥ë‹˜ê»˜ ìë™ ë°œì†¡í•©ë‹ˆë‹¤.
*   **ì£¼ì˜**: Google ì•± ë¹„ë°€ë²ˆí˜¸ê°€ í•„ìš”í•©ë‹ˆë‹¤. (ì‹¤í–‰ ê°€ì´ë“œ ì°¸ê³ )

```python
import smtplib
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from email.mime.application import MIMEApplication
import os

def send_email(subject, body, to_email, attachment_data=None, filename="result.xlsx"):
    # í™˜ê²½ë³€ìˆ˜ì—ì„œ ì„¤ì • ë¡œë“œ
    smtp_server = "smtp.gmail.com"
    smtp_port = 587
    sender_email = os.environ.get("GMAIL_USER")     # ë‚´ ì´ë©”ì¼
    password = os.environ.get("GMAIL_PASSWORD")     # ì•± ë¹„ë°€ë²ˆí˜¸

    if not sender_email or not password:
        return "í™˜ê²½ë³€ìˆ˜ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤."

    try:
        msg = MIMEMultipart()
        msg['From'] = sender_email
        msg['To'] = to_email
        msg['Subject'] = subject

        msg.attach(MIMEText(body, 'plain'))

        # ì²¨ë¶€íŒŒì¼ ì¶”ê°€
        if attachment_data:
            part = MIMEApplication(attachment_data, Name=filename)
            part['Content-Disposition'] = f'attachment; filename="{filename}"'
            msg.attach(part)

        # SMTP ì—°ê²° ë° ë°œì†¡
        server = smtplib.SMTP(smtp_server, smtp_port)
        server.starttls()
        server.login(sender_email, password)
        server.send_message(msg)
        server.quit()
        
        return "ì„±ê³µ"
        
    except Exception as e:
        return f"ì‹¤íŒ¨: {str(e)}"
```

---

## 5. UI êµ¬í˜„ (app.py)

Streamlitìœ¼ë¡œ ì§ê´€ì ì¸ ëŒ€ì‹œë³´ë“œë¥¼ ë§Œë“­ë‹ˆë‹¤.

```python
import streamlit as st
import pandas as pd
from src.processor import ExcelProcessor
from src.mailer import send_email
from dotenv import load_dotenv
import os

# í™˜ê²½ë³€ìˆ˜ ë¡œë“œ
load_dotenv()

st.set_page_config(page_title="ì›í´ë¦­ ì •ì‚° ì‹œìŠ¤í…œ", page_icon="ğŸ“Š")

st.title("ğŸ“Š ì›í´ë¦­ ì •ì‚° ë° ë¦¬í¬íŠ¸ ìë™í™”")
st.markdown("ì—‘ì…€ íŒŒì¼ë“¤ì„ ë“œë˜ê·¸í•˜ë©´ **ë‹¨ 1ì´ˆ ë§Œì—** í†µí•© ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.")

# 1. íŒŒì¼ ì—…ë¡œë“œ ì„¹ì…˜
files = st.file_uploader(
    "ì£¼ê°„ ì‹¤ì  ì—‘ì…€ íŒŒì¼ë“¤ì„ ëª¨ë‘ ì˜¬ë ¤ì£¼ì„¸ìš” (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥)", 
    accept_multiple_files=True,
    type=['xlsx']
)

if files:
    st.success(f"{len(files)}ê°œì˜ íŒŒì¼ì´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.")
    
    if st.button("ğŸš€ ë¦¬í¬íŠ¸ ìƒì„± ì‹œì‘"):
        with st.spinner('ë°ì´í„° ë¶„ì„ ë° ë³‘í•© ì¤‘...'):
            processor = ExcelProcessor()
            
            # ë³‘í•© ë° ê²€ì¦ ì‹¤í–‰
            merged_df, error_log = processor.validate_and_merge(files)
            
            # ì˜¤ë¥˜ ì¶œë ¥
            if error_log:
                st.warning("âš ï¸ ì¼ë¶€ íŒŒì¼ì—ì„œ ë¬¸ì œê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤:")
                for err in error_log:
                    st.error(f"- {err['file']}: {err['error']}")
            
            if merged_df is not None:
                # ê²°ê³¼ ë¦¬í¬íŠ¸ ìƒì„±
                report_df = processor.create_report(merged_df)
                
                st.subheader("ğŸ“‹ ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸°")
                st.dataframe(report_df.style.highlight_max(axis=0))
                
                # ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì¤€ë¹„
                excel_data = processor.save_to_excel(report_df)
                
                col1, col2 = st.columns(2)
                
                with col1:
                    st.download_button(
                        label="ğŸ“¥ ì—‘ì…€ ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œ",
                        data=excel_data,
                        file_name="í†µí•©_ì£¼ê°„ë¦¬í¬íŠ¸.xlsx",
                        mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                    )
                
                with col2:
                    # ì´ë©”ì¼ ë°œì†¡ ê¸°ëŠ¥ (ì„ íƒì‚¬í•­)
                    target_email = st.text_input("ë°›ì„ ì´ë©”ì¼ ì£¼ì†Œ", placeholder="manager@company.com")
                    if st.button("ğŸ“§ ì´ë©”ì¼ë¡œ ë°”ë¡œ ì „ì†¡"):
                        if target_email:
                            result = send_email(
                                subject="[ìë™ë°œì†¡] ì£¼ê°„ í†µí•© ì‹¤ì  ë¦¬í¬íŠ¸",
                                body="ìš”ì²­í•˜ì‹  ë¦¬í¬íŠ¸ê°€ ìƒì„±ë˜ì–´ ì²¨ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.",
                                to_email=target_email,
                                attachment_data=excel_data
                            )
                            if result == "ì„±ê³µ":
                                st.success("ë©”ì¼ ë°œì†¡ ì™„ë£Œ!")
                            else:
                                st.error(f"ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨: {result}")
                        else:
                            st.warning("ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")

            else:
                st.error("ì²˜ë¦¬ ê°€ëŠ¥í•œ ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")

st.markdown("---")
st.caption("Developed by AI Operator | Powered by Python & Streamlit")
```
